<!DOCTYPE html>

<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity4">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="renderer" content="webkit">

  <!--[if lt IE 9]>
  <meta http-equiv="refresh" content="0;ie.html"/>
  <![endif]-->
  <title>我的查询 - ODMP控制中心</title>

  <link rel="shortcut icon" href="../static/favicon.ico" th:href="@{/favicon.ico}">
  <link href="../static/css/bootstrap.min.css?v=3.3.6" rel="stylesheet"
        th:href="@{/css/bootstrap.min.css}">
  <link href="../static/css/bootstrap-datepicker3.min.css" rel="stylesheet"
        th:href="@{/css/bootstrap-datepicker3.min.css}">
  <script src="../static/js/jquery-1.10.2.min.js?v=2.1.4"
          th:src="@{/js/jquery-1.10.2.min.js}"></script>
  <script src="../static/js/bootstrap.min.js?v=3.3.6"
          th:src="@{/js/bootstrap.min.js}"></script>
  <script src="../static/js/bootstrap-datepicker.min.js"
          th:src="@{/js/bootstrap-datepicker.min.js}"></script>
  <script src="../static/js/locales/bootstrap-datepicker.zh-CN.min.js"
          th:src="@{/js/locales/bootstrap-datepicker.zh-CN.min.js}"></script>
  <script src="../static/js/jquery.form.js" th:src="@{/js/jquery.form.js}"></script>
  <script>
    var ot;//上传开始时间
    var oloaded;//已上传文件大小
    var xhr;

    function uploadFile() {
      var fileObj = document.getElementsByName("file")[0].files[0]; //js获取文件对象
      var url = "/intern/upload/result";
      // FormData 对象
      var form = new FormData();
      form.append('file', fileObj); // 文件对象
      form.append('data', $("#data").val());
      // XMLHttpRequest 对象
      xhr = new XMLHttpRequest();
      xhr.onreadystatechange = callback;
      xhr.onload = uploadComplete; //请求完成
      xhr.onerror = uploadFailed; //请求失败
      document.getElementById("progress").style.display = 'block';
      xhr.upload.onprogress = progressFunction;//【上传进度调用方法实现】
      xhr.upload.onloadstart = function () {//上传开始执行方法
        ot = new Date().getTime();   //设置上传开始时间
        oloaded = 0;//设置上传开始时，以上传的文件大小为0
      };

      //上传开始执行方法
      xhr.onloadstart = function () {
        console.log('开始上传');
        ot = new Date().getTime();   //设置上传开始时间
        oloaded = 0;//已上传的文件大小为0
      };
      xhr.upload.onprogress = progressFunction;//【上传进度调用方法实现】
      //true为异步处理
      xhr.open('post', url, true);
      xhr.send(form);
    }

    function callback() {
      if (xhr.readyState == 4) {
        //判断http的交互是否成功
        if (xhr.status == 200) {
          var box = document.getElementById("success");
          box.style.display = "block";
          setTimeout(function () {
            box.style.display = "none";
            document.getElementById("progress").style.display = 'none';
            setProgress(0);
            location.reload();
          }, 3000);
        } else {
          var box1 = document.getElementById("fail");
          box1.style.display = "block";
          setTimeout(function () {
            box1.style.display = "none";
          }, 3000);
        }
      }
    }

    function progressFunction(evt) {
      if (evt.lengthComputable) {
        var completePercent = Math.round(evt.loaded / evt.total * 100)
            + '%';
        document.getElementById("progressBar").style.width = completePercent;
        document.getElementById("progressBar").value = completePercent;
        ot = new Date().getTime();          //重新赋值时间，用于下次计算
        oloaded = evt.loaded;               //重新赋值已上传文件大小
        document.getElementById("showInfo").innerHTML = '已上传：' + completePercent;
      }
    }

    //上传成功后回调
    function uploadComplete(evt) {
      //服务断接收完文件返回的结果
      console.log(evt);
      console.log('上传完成')
    };

    //上传失败回调
    function uploadFailed(evt) {
      console.log('上传失败(上传数据最大不能超过100M) ' + evt.target.responseText);
    }

    //终止上传
    function cancelUpload() {
      xhr.abort();
    }

    //上传取消后回调
    function uploadCanceled(evt) {
      console.log('上传取消,上传被用户取消或者浏览器断开连接:' + evt.target.responseText);
    }

    function setProgress(w) {
      document.getElementById("progressBar").style.width = w + "%";
    }

    function F_Open_dialog() {
      document.getElementById("btn_file").click();
    }

    function uploadfile() {
      $("#form1").submit();
    }

    function uploadResult(type1, type2, type3) {
      var data = {
        "batch_id": type1,
        "status": type2,
        "org": type3
      };
      $("#data").val(JSON.stringify(data));
      document.getElementById("select").click();
    }

    function refuse(type) {
      $("#id").val(JSON.stringify(type));
      $("#id2").click();
    }

    function refusePost() {
      event.preventDefault();
      $('#form2').ajaxSubmit(function (message) {
            if (message === "success") {
              var box = document.getElementById("close");
              box.style.display = "block";
              setTimeout(function () {
                location.reload();
                box.style.display = "none";
              }, 3000);
            }
          }
      );
      return false;
    }

    function queryPost() {
      event.preventDefault();
      uploadFile();
      return false;
    }

    function downloadParameter(type) {
      var href = "/intern/download/file/id=" + type;
      $.get(href, function (data, message, request) {
        var name = request.getResponseHeader("Content-Disposition");
        var arr = name.split("=");
        var filename = arr[arr.length - 1];
        // 创建隐藏的可下载链接
        var eleLink = document.createElement('a');
        eleLink.download = filename;
        eleLink.style.display = 'none';
        // 字符内容转变成blob地址
        var blob = new Blob([data]);
        eleLink.href = URL.createObjectURL(blob);
        // 触发点击
        document.body.appendChild(eleLink);
        eleLink.click();
        // 然后移除
        document.body.removeChild(eleLink);
        setTimeout(
            function () {
              location.reload();
            }, 500);
      });
      return false;
    }
  </script>
</head>

<body>
<nav class="navbar navbar-inverse navbar-static-top" th:replace="fragments/header :: header">
  <!-- ============================================================================ -->
  <!-- This content is only used for static prototyping purposes (natural templates)-->
  <!-- and is therefore entirely optional, as this markup fragment will be replaced -->
  <!-- with "fragments/header.html" at runtime.                                     -->
  <!-- ============================================================================ -->
  <div class="container">
    <div class="navbar-header">
      <a class="navbar-brand" href="#">ODMP控制中心</a>
    </div>
    <div class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li class="active"><a href="#">首页</a></li>
      </ul>
    </div>
  </div>
</nav>
<label style="visibility: hidden" id="username" sec:authentication="name"></label>
<!-- 获得当前用户的用户名 -->
<div class="container">
  <div class="row">
    <div class="col-md-12">
      <h1 class="page-header">我的查询
        <small>选择日期或类型过滤</small>
      </h1>
    </div>
  </div>
  <div class="row">
    <div class="col-md-12"
         style="padding-left: 0; padding-right: 0; margin-bottom: 0; display: none"
         id="progress">
      <div
          class="progress">
        <div id="progressBar" class="progress-bar progress-bar-success"
             role="progressbar" aria-valuemin="0" aria-valuenow="0"
             aria-valuemax="100" style="width: 0%"></div>
      </div>
      <!-- 显示上传速度 -->
      <div id="showInfo" class="col-lg-2">0KB/s</div>
      <br>
      <p class="alert alert-info" style="display: none" id="close">查询已关闭</p>
      <p class="alert alert-success" style="display: none" id="success">上传完成</p>
      <p id="fail" class="alert alert-warning" style="display: none">上传失败</p>
    </div>
  </div>
  <div class="row">
    <div class="col-md-12">
      <form action="/batches" method="get" th:action="@{/batches}">
        <div class="row form-group">
          <div class="col-md-5">
            <label for="dateFilterPicker">日期：</label>
            <div class="input-group input-daterange" id="dateFilterPicker">
              <div class="input-group-addon"> 从</div>
              <input type="text" id="start_time" name="start" th:value="${start_dt}"
                     class="form-control">
              <div class="input-group-addon"> 到</div>
              <input type="text" id="end_time" name="end" th:value="${end_dt}" class="form-control">
            </div>
          </div>
          <div class="col-md-2">
            <label for="categoryFilterPicker">类型：</label>
            <select class="form-control" name="category" id="categoryFilterPicker">
              <option th:value="0" th:selected="${category == 0}">所有类型</option>
              <option th:value="1" th:selected="${category == 1}">我发起的</option>
              <option th:value="2" th:selected="${category == 2}">我收到的</option>
            </select>
          </div>
          <div class="col-md-1 col-md-offset-4">
            <label for="submit" class="sr-only"></label>
            <button class="btn btn-default" id="submit" type="submit">过滤</button>
          </div>
          <script>
            $('.input-daterange input').parent().datepicker({
              todayHighlight: true,
              autoclose: true, format: "yyyy-mm-dd", language: "zh-CN"
            });
          </script>
        </div>
      </form>
    </div>
  </div>
  <div class="row">
    <table class="table table-striped table-bordered table-hover" id="batchTable">
      <thead>
      <tr>
        <th>批次</th>
        <th>提交时间</th>
        <th>完成时间</th>
        <th>类型</th>
        <th>状态</th>
        <th>对方机构</th>
        <th>操作</th>
      </tr>
      </thead>
      <tbody id="batchTableBody">
      <tr th:each="batch : ${batches}">
        <td th:text="${batch.batchId}">#</td>
        <td th:text="${batch.submitTime}">#</td>
        <td th:text="${batch.completeTime != null ? batch.completeTime : '-'}">#</td>
        <td th:text="${batch.category == 1 ? '我发起的' : '我收到的'}">#</td>
        <td th:text="${batch.status == 0 ? '已接受' : batch.status == 1 ? '查询中' : batch.status == 2 ? '已完成' : batch.status == 3 ? '已拒绝' : '已关闭'}">
          #
        </td>
        <td th:text="${batch.counterpart}">#</td>
        <td>
          <a th:if="${batch.category == 1 and batch.status == 2 }" role="button"
             class="btn btn-default btn-primary"
             href="#"
             th:href="@{/intern/download/resulting/id={batch_id} (batch_id=${batch.batchId})}">下载结果
          </a>
          <a th:if="${batch.category == 1 and batch.status != 2 }" role="button"
             class="btn btn-default btn-primary"
             href="#"
             th:classappend="disabled">下载结果
          </a>

          <a th:if="${batch.category == 2 and batch.status != 3 and batch.status != 4 }"
             class="btn btn-default" href="#" role="button"
             th:href="@{/intern/download/file/id={batch_id} (batch_id=${batch.batchId})}"
             onclick="void(0)" th:onclick="${ 'return downloadParameter(' + batch.batchId + ')' }"
             id="f1">下载参数</a>
          <a th:if="${batch.category == 2 and batch.status != 0 and batch.status != 1 and batch.status != 2 }"
             class="btn btn-default" href="#" role="button"
             th:classappend="disabled">下载参数</a>

          <button th:if="${batch.category == 2 and batch.status == 1 }"
                  class="btn btn-default btn-primary"
                  onclick="void(0)"
                  th:onclick="${'uploadResult(' + batch.batchId + ',' + batch.status + ',''' + batch.counterpart + ''')' }">
            上传结果
          </button>
          <button th:if="${batch.category == 2 and batch.status != 1 }"
                  class="btn btn-default btn-primary"
                  onclick="void(0)"
                  th:classappend="disabled">
            上传结果
          </button>

          <button th:if="${batch.category == 2 and ( batch.status == 0 or batch.status == 1 )}"
                  class="btn btn-default btn-danger"
                  onclick="void(0)" th:onclick="${ 'refuse(' + batch.batchId + ')' }">关闭查询
          </button>
          <button th:if="${batch.category == 2 and batch.status != 0 and batch.status != 1}"
                  class="btn btn-default btn-danger"
                  onclick="void(0)"
                  th:classappend="disabled">关闭查询
          </button>
        </td>
      </tr>
      </tbody>
    </table>
    <nav aria-label="Page navigation" class="text-center">
      <ul class="pagination">
        <li>
          <a href="#"
             th:href="@{/batches?page=1&start={start_dt}&end={end_dt}&category={cat} (start_dt=${start_dt}, end_dt=${end_dt}, cat=${category})}"
             aria-label="Previous"><span aria-hidden="true">&laquo;</span></a>
        </li>
        <li th:each="i : ${#numbers.sequence( 1, (count - 1) / 10 + 1 )}"
            th:classappend="${page_num == i ? 'active' : ''}">
          <a href="#"
             th:href="@{/batches?page={page_num}&start={start_dt}&end={end_dt}&category={cat} (page_num=${i}, start_dt=${start_dt}, end_dt=${end_dt}, cat=${category})}"
             th:text="${i}">1</a>
        </li>
        <li>
          <a href="#"
             th:href="@{/batches?page={max_page}&start={start_dt}&end={end_dt}&category={cat} (max_page=${(count - 1) / 10 + 1}, start_dt=${start_dt}, end_dt=${end_dt}, cat=${category})}"
             aria-label="Next"><span aria-hidden="true">&raquo;</span></a>
        </li>
      </ul>
    </nav>
  </div>

  <form id="form1" style="display: none" enctype="multipart/form-data" onsubmit="return queryPost()"
        action="/intern/upload/result" th:action="@{/intern/upload/result}" method="post">
    <input name="data" type="text" id="data">
    <input type="file" id="btn_file" style="display:none" name="file" onchange="uploadfile()">
    <button type="button" onclick="F_Open_dialog()" id="select">选择文件</button>
  </form>

  <form id="form2" style="display: none" enctype="multipart/form-data"
        action="/intern/refuse" th:action="@{/intern/refuse}"
        method="post" onsubmit="return refusePost()">
    <input name="id" type="text" id="id"/>
    <button type="submit" class="btn btn-default" id="id2">关闭查询</button>
  </form>

  <footer th:replace="fragments/footer :: footer" class="text-center">&copy; 2017 Default Footer
  </footer>
</div>
</body>
</html>
